<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fravær Registrering - Clean</title>
    <meta name="description" content="App for flyktninger til å registrere deltakelse og fravær">
    <meta name="theme-color" content="#0078d4">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- MSAL Library -->
    <script src="lib/msal-browser.min.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Laster app...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen hidden">
        <div class="login-container">
            <div class="login-header">
                <h1>Fravær Registrering</h1>
                <p>For flyktninger</p>
            </div>
            <div class="login-content">
                <button id="login-btn" class="btn btn-primary">
                    <span class="icon">🔐</span>
                    Logg inn
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-screen" class="screen hidden">
        <div class="screen-header">
            <h1>Fravær Registrering</h1>
            <button id="logout-btn" class="btn-logout">Logg ut</button>
        </div>
        <div class="screen-content">
            <div class="menu-cards">
                <div class="menu-card">
                    <h3>Registrer deltakelse</h3>
                    <p>Meld fravær eller deltakelse</p>
                    <button class="btn btn-primary">Start</button>
                </div>
                <div class="menu-card">
                    <h3>Se oversikt</h3>
                    <p>Se din fraværsoversikt</p>
                    <button class="btn btn-secondary">Åpne</button>
                </div>
                <div class="menu-card">
                    <h3>Test Dataverse</h3>
                    <p>Test tilkobling til Dataverse</p>
                    <button id="test-dataverse-btn" class="btn btn-info">Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple App Script -->
    <script>
        console.log('=== CLEAN APP STARTING ===');
        console.log('Timestamp:', new Date().toISOString());
        
        class CleanApp {
            constructor() {
                console.log('🚀 CleanApp constructor called');
                this.currentScreen = 'loading-screen';
                this.initialized = false;
                this.msalInstance = null;
                this.currentUser = null;
            }
            
            async initialize() {
                if (this.initialized) {
                    console.log('App already initialized, skipping...');
                    return;
                }
                
                console.log('🔧 Initializing CleanApp...');
                this.initialized = true;
                
                // Initialize MSAL
                await this.initializeMSAL();
                
                // Initialize Service Worker
                await this.initializeServiceWorker();
                
                // Initialize Dataverse
                await this.initializeDataverse();
                
                // Show login screen after 2 seconds
                setTimeout(() => {
                    console.log('⏰ Timeout reached, showing login screen...');
                    this.showScreen('login-screen');
                    
                    // Fallback: Force show login screen if still on loading
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                            console.log('🚨 Fallback: Force showing login screen');
                            loadingScreen.classList.add('hidden');
                            loadingScreen.style.display = 'none';
                            const loginScreen = document.getElementById('login-screen');
                            if (loginScreen) {
                                loginScreen.classList.remove('hidden');
                                loginScreen.style.display = 'flex';
                                console.log('🚨 Fallback: Login screen forced to show');
                            }
                        }
                    }, 1000);
                }, 2000);
                
                // Set up event listeners
                this.setupEventListeners();
                
                console.log('✅ CleanApp initialized successfully');
            }
            
            async initializeMSAL() {
                console.log('🔐 Initializing MSAL...');
                
                if (typeof msal === 'undefined') {
                    console.log('MSAL not available, using mock authentication');
                    return;
                }
                
                try {
                    const msalConfig = {
                        auth: {
                            clientId: 'mock-client-id',
                            authority: 'https://login.microsoftonline.com/mock-tenant'
                        }
                    };
                    
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    console.log('✅ MSAL initialized successfully');
                } catch (error) {
                    console.error('❌ MSAL initialization failed:', error);
                }
            }
            
            async initializeServiceWorker() {
                console.log('🔧 Initializing Service Worker...');
                
                if (!('serviceWorker' in navigator)) {
                    console.log('Service Worker not supported');
                    return;
                }
                
                if (window.serviceWorkerRegistered) {
                    console.log('Service Worker already registered');
                    return;
                }
                
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('✅ Service Worker registered successfully:', registration);
                    window.serviceWorkerRegistered = true;
                } catch (error) {
                    console.error('❌ Service Worker registration failed:', error);
                }
            }
            
            async initializeDataverse() {
                console.log('🗄️ Initializing Dataverse...');
                
                try {
                    // Mock Dataverse configuration
                    this.dataverseConfig = {
                        baseUrl: 'https://mock-dataverse.crm.dynamics.com',
                        apiVersion: '9.2',
                        mockMode: true
                    };
                    
                    console.log('✅ Dataverse initialized successfully (mock mode)');
                } catch (error) {
                    console.error('❌ Dataverse initialization failed:', error);
                }
            }
            
            showScreen(screenId) {
                console.log('📱 Showing screen:', screenId);
                
                // Hide all screens with multiple methods
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                });
                
                // Show target screen with multiple methods
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.style.display = 'flex';
                    this.currentScreen = screenId;
                    console.log('✅ Screen shown:', screenId);
                    console.log('Screen element:', targetScreen);
                    console.log('Screen classes:', targetScreen.className);
                    console.log('Screen style:', targetScreen.style.display);
                } else {
                    console.error('❌ Screen not found:', screenId);
                }
            }
            
            setupEventListeners() {
                console.log('🔗 Setting up event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        console.log('🔐 Login button clicked');
                        this.handleLogin();
                    });
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log('🚪 Logout button clicked');
                        this.handleLogout();
                    });
                }
                
                // Test Dataverse button
                const testDataverseBtn = document.getElementById('test-dataverse-btn');
                if (testDataverseBtn) {
                    testDataverseBtn.addEventListener('click', async () => {
                        console.log('🔗 Test Dataverse button clicked');
                        const result = await this.testDataverseConnection();
                        console.log('Dataverse test result:', result);
                        alert(`Dataverse test: ${result.success ? 'Success' : 'Failed'} - ${result.message}`);
                    });
                }
                
                console.log('✅ Event listeners set up');
            }
            
            async handleLogin() {
                console.log('🔐 Handling login...');
                
                if (this.msalInstance) {
                    try {
                        console.log('Using MSAL for authentication...');
                        // Mock login for now
                        this.currentUser = { name: 'Test User', email: 'test@example.com' };
                        console.log('✅ Mock login successful');
                    } catch (error) {
                        console.error('❌ MSAL login failed:', error);
                        // Fallback to mock login
                        this.currentUser = { name: 'Test User', email: 'test@example.com' };
                    }
                } else {
                    console.log('Using mock authentication...');
                    this.currentUser = { name: 'Test User', email: 'test@example.com' };
                }
                
                this.showScreen('main-screen');
            }
            
            handleLogout() {
                console.log('🚪 Handling logout...');
                this.currentUser = null;
                this.showScreen('login-screen');
            }
            
            async testDataverseConnection() {
                console.log('🔗 Testing Dataverse connection...');
                
                if (this.dataverseConfig && this.dataverseConfig.mockMode) {
                    console.log('✅ Dataverse connection test successful (mock mode)');
                    return { success: true, message: 'Mock connection successful' };
                } else {
                    console.log('❌ Dataverse not configured');
                    return { success: false, message: 'Dataverse not configured' };
                }
            }
        }
        
        // Initialize app when page loads
        window.addEventListener('load', () => {
            console.log('🌐 Window loaded, creating CleanApp...');
            window.cleanApp = new CleanApp();
            window.cleanApp.initialize();
        });
        
        console.log('=== CLEAN APP SCRIPT LOADED ===');
    </script>
</body>
</html>
