<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frav√¶r Registrering - Clean</title>
    <meta name="description" content="App for flyktninger til √• registrere deltakelse og frav√¶r">
    <meta name="theme-color" content="#0078d4">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Punkt CSS Framework -->
    <link href="https://punkt-cdn.oslo.kommune.no/latest/css/pkt.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    
        <!-- MSAL Library - Use real MSAL from CDN with local fallback -->
        <script src="https://unpkg.com/@azure/msal-browser@2.38.4/lib/msal-browser.min.js"
                onload="console.log('‚úÖ Real MSAL loaded from CDN');"
                onerror="console.error('CDN failed, loading local MSAL...');
                         var script = document.createElement('script');
                         script.src = 'lib/msal-browser-real.min.js';
                         script.onload = function() { console.log('‚úÖ Real MSAL loaded from local file'); };
                script.onerror = function() {
                             console.log('Loading mock MSAL...');
                             var mockScript = document.createElement('script');
                             mockScript.src = 'lib/msal-browser.min.js';
                             document.head.appendChild(mockScript);
                         };
                         document.head.appendChild(script);"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen pkt-section pkt-section--grey">
        <div class="loading-spinner"></div>
        <p class="pkt-txt-24-medium">Laster app...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen hidden">
        <div class="login-container pkt-section pkt-section--white">
            <div class="login-header">
                <img src="https://punkt-cdn.oslo.kommune.no/latest/logos/oslologo.svg" 
                     alt="Oslo kommune logo" 
                     class="oslologo" 
                     height="80">
                <h1 class="pkt-txt-36-bold">Frav√¶r Registrering</h1>
                <p class="pkt-txt-18">For flyktninger</p>
            </div>
            <div class="login-content">
                <button id="login-btn" class="pkt-btn pkt-btn--primary pkt-btn--large">
                    <span class="icon">üîê</span>
                    Logg inn
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <h1 class="pkt-txt-28-bold">Frav√¶r Registrering</h1>
            <div class="user-info">
                <span id="user-name" class="pkt-txt-16">Bruker</span>
                <button id="logout-btn" class="pkt-btn pkt-btn--secondary">Logg ut</button>
            </div>
        </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <div class="menu-cards">
                <div class="menu-card pkt-section pkt-section--white">
                    <h3 class="pkt-txt-20-bold">Registrer deltakelse</h3>
                    <p class="pkt-txt-16">Meld frav√¶r eller deltakelse</p>
                    <button id="register-attendance-btn" class="pkt-btn pkt-btn--primary">Start</button>
                </div>
                <div class="menu-card pkt-section pkt-section--white">
                    <h3 class="pkt-txt-20-bold">Se oversikt</h3>
                    <p class="pkt-txt-16">Se din frav√¶rsoversikt</p>
                    <button class="pkt-btn pkt-btn--secondary">√Öpne</button>
                </div>
                <div class="menu-card pkt-section pkt-section--white">
                    <h3 class="pkt-txt-20-bold">Test Dataverse</h3>
                    <p class="pkt-txt-16">Test tilkobling til Dataverse</p>
                    <button id="test-dataverse-btn" class="pkt-btn pkt-btn--tertiary">Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Form Screen -->
    <div id="attendance-form-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <button id="back-to-main-btn" class="pkt-btn pkt-btn--secondary">‚Üê Tilbake</button>
            <h1 class="pkt-txt-28-bold">Registrer deltakelse</h1>
        </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <form id="attendance-form" class="form pkt-section pkt-section--white">
                <div class="form-group">
                    <label for="socio_deltakelse_fra" class="pkt-txt-16-bold">Fra dato *</label>
                    <input type="date" id="socio_deltakelse_fra" name="socio_deltakelse_fra" class="pkt-input" required>
                </div>
                
                <div class="form-group">
                    <label for="socio_deltakelse_til" class="pkt-txt-16-bold">Til dato *</label>
                    <input type="date" id="socio_deltakelse_til" name="socio_deltakelse_til" class="pkt-input" required>
                </div>
                
                <div class="form-group">
                    <label for="socio_type" class="pkt-txt-16-bold">Type *</label>
                    <select id="socio_type" name="socio_type" class="pkt-select" required>
                        <option value="">Velg type...</option>
                        <option value="1">Tilstede</option>
                        <option value="2">Frav√¶r</option>
                        <option value="3">Deltakelse</option>
                        <option value="4">Permisjon</option>
                        <option value="5">Syk</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="socio_status" class="pkt-txt-16-bold">Status *</label>
                    <select id="socio_status" name="socio_status" class="pkt-select" required>
                        <option value="1">Registrert</option>
                        <option value="2">Godkjent</option>
                        <option value="3">Avsl√•tt</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="socio_beskrivelse" class="pkt-txt-16-bold">Beskrivelse</label>
                    <textarea id="socio_beskrivelse" name="socio_beskrivelse" 
                              class="pkt-textarea"
                              placeholder="Beskriv deltagelsen..." 
                              maxlength="1000" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="socio_varighet" class="pkt-txt-16-bold">Varighet (timer)</label>
                    <input type="number" id="socio_varighet" name="socio_varighet" 
                           class="pkt-input"
                           min="0" max="24" step="0.5" placeholder="0">
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-form-btn" class="pkt-btn pkt-btn--secondary">Avbryt</button>
                    <button type="submit" id="save-attendance-btn" class="pkt-btn pkt-btn--primary">Lagre</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Simple App Script -->
    <script>
        console.log('=== CLEAN APP STARTING ===');
        console.log('Timestamp:', new Date().toISOString());
        
        class CleanApp {
            constructor() {
                console.log('üöÄ CleanApp constructor called');
                this.currentScreen = 'loading-screen';
                this.initialized = false;
                this.msalInstance = null;
                this.currentUser = null;
            }
            
            async initialize() {
                if (this.initialized) {
                    console.log('App already initialized, skipping...');
                    return;
                }
                
                console.log('üîß Initializing CleanApp...');
                this.initialized = true;
                
                // Initialize MSAL
                await this.initializeMSAL();
                
                // Initialize Service Worker
                await this.initializeServiceWorker();
                
                // Initialize Dataverse
                await this.initializeDataverse();
                
                // Show login screen after 2 seconds
                setTimeout(() => {
                    console.log('‚è∞ Timeout reached, showing login screen...');
                    this.showScreen('login-screen');
                    
                    // Fallback: Force show login screen if still on loading
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                            console.log('üö® Fallback: Force showing login screen');
                            loadingScreen.classList.add('hidden');
                            loadingScreen.style.display = 'none';
                            const loginScreen = document.getElementById('login-screen');
                            if (loginScreen) {
                                loginScreen.classList.remove('hidden');
                                loginScreen.style.display = 'flex';
                                console.log('üö® Fallback: Login screen forced to show');
                            }
                        }
                    }, 1000);
                }, 2000);
                
                // Set up event listeners
                this.setupEventListeners();
                
                console.log('‚úÖ CleanApp initialized successfully');
            }
            
            async initializeMSAL() {
                console.log('üîê Initializing MSAL...');
                
                // Wait a bit for the script to load
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (typeof msal === 'undefined' || !msal.PublicClientApplication) {
                    console.log('‚ö†Ô∏è Real MSAL not available, using mock authentication');
                    return;
                }
                
                console.log('‚úÖ Real Microsoft MSAL detected');
                
                try {
                    // Real Entra ID configuration from CONFIG
                    const msalConfig = {
                        auth: {
                            clientId: 'c25b351f-417b-46cf-b736-2970d45273fc',
                            authority: 'https://login.microsoftonline.com/fb7e0b12-d8fc-4f14-bd1a-ad9c8667a7e6',
                            redirectUri: window.location.origin
                        },
                        cache: {
                            cacheLocation: 'localStorage',
                            storeAuthStateInCookie: false
                        }
                    };
                    
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    
                    // Handle redirect promise
                    await this.msalInstance.handleRedirectPromise();
                    
                    console.log('‚úÖ MSAL initialized successfully with Entra ID');
                } catch (error) {
                    console.error('‚ùå MSAL initialization failed:', error);
                    console.log('Falling back to mock authentication');
                }
            }
            
            async initializeServiceWorker() {
                console.log('üîß Initializing Service Worker...');
                
                if (!('serviceWorker' in navigator)) {
                    console.log('Service Worker not supported');
                    return;
                }
                
                if (window.serviceWorkerRegistered) {
                    console.log('Service Worker already registered');
                    return;
                }
                
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registered successfully:', registration);
                    window.serviceWorkerRegistered = true;
                } catch (error) {
                    console.error('‚ùå Service Worker registration failed:', error);
                }
            }
            
            async initializeDataverse() {
                console.log('üóÑÔ∏è Initializing Dataverse...');
                
                try {
                    // Real Dataverse configuration from CONFIG
                    this.dataverseConfig = {
                        baseUrl: 'https://smittevaksine2022utvikling.crm4.dynamics.com/api/data/v9.2/',
                        apiVersion: '9.2',
                        entities: {
                            user: 'new_bruker',
                            participation: 'new_deltakelse',
                            absence: 'new_frav√¶r'
                        },
                        mockMode: false // Set to true for offline development
                    };
                    
                    console.log('‚úÖ Dataverse initialized successfully');
                } catch (error) {
                    console.error('‚ùå Dataverse initialization failed:', error);
                }
            }
            
            showScreen(screenId) {
                console.log('üì± Showing screen:', screenId);
                
                // Hide all screens with multiple methods
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                });
                
                // Show target screen with multiple methods
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.style.display = 'flex';
                    this.currentScreen = screenId;
                    console.log('‚úÖ Screen shown:', screenId);
                    console.log('Screen element:', targetScreen);
                    console.log('Screen classes:', targetScreen.className);
                    console.log('Screen style:', targetScreen.style.display);
                } else {
                    console.error('‚ùå Screen not found:', screenId);
                }
            }
            
            setupEventListeners() {
                console.log('üîó Setting up event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        console.log('üîê Login button clicked');
                        this.handleLogin();
                    });
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log('üö™ Logout button clicked');
                        this.handleLogout();
                    });
                }
                
                // Test Dataverse button
                const testDataverseBtn = document.getElementById('test-dataverse-btn');
                if (testDataverseBtn) {
                    testDataverseBtn.addEventListener('click', async () => {
                        console.log('üîó Test Dataverse button clicked');
                        const result = await this.testDataverseConnection();
                        console.log('Dataverse test result:', result);
                        alert(`Dataverse test: ${result.success ? 'Success' : 'Failed'} - ${result.message}`);
                    });
                }
                
                // Register attendance button
                const registerAttendanceBtn = document.getElementById('register-attendance-btn');
                if (registerAttendanceBtn) {
                    registerAttendanceBtn.addEventListener('click', () => {
                        console.log('üìù Register attendance button clicked');
                        this.showScreen('attendance-form-screen');
                    });
                }
                
                // Back to main button
                const backToMainBtn = document.getElementById('back-to-main-btn');
                if (backToMainBtn) {
                    backToMainBtn.addEventListener('click', () => {
                        console.log('‚Üê Back to main button clicked');
                        this.showScreen('main-screen');
                    });
                }
                
                // Cancel form button
                const cancelFormBtn = document.getElementById('cancel-form-btn');
                if (cancelFormBtn) {
                    cancelFormBtn.addEventListener('click', () => {
                        console.log('‚ùå Cancel form button clicked');
                        this.showScreen('main-screen');
                    });
                }
                
                // Attendance form submit
                const attendanceForm = document.getElementById('attendance-form');
                if (attendanceForm) {
                    attendanceForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        console.log('üíæ Attendance form submitted');
                        await this.handleAttendanceSubmit();
                    });
                }
                
                console.log('‚úÖ Event listeners set up');
            }
            
            async handleLogin() {
                console.log('üîê Handling login...');
                
                if (this.msalInstance) {
                    try {
                        console.log('Using MSAL for Entra ID authentication...');
                        
                        // Check if user is already logged in
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            console.log('User already logged in:', accounts[0]);
                            this.currentUser = {
                                name: accounts[0].name,
                                email: accounts[0].username,
                                account: accounts[0]
                            };
                            this.showScreen('main-screen');
                            return;
                        }
                        
                        // Login with popup - use Dataverse scope
                        const loginRequest = {
                            scopes: ['https://smittevaksine2022utvikling.crm4.dynamics.com/.default'],
                            prompt: 'select_account'
                        };
                        
                        const response = await this.msalInstance.loginPopup(loginRequest);
                        console.log('‚úÖ Entra ID login successful:', response);
                        
                        this.currentUser = {
                            name: response.account.name,
                            email: response.account.username,
                            account: response.account
                        };
                        
                    } catch (error) {
                        console.error('‚ùå Entra ID login failed:', error);
                        console.log('Falling back to mock authentication');
                        this.currentUser = { name: 'Test User', email: 'test@example.com' };
                    }
                } else {
                    console.log('Using mock authentication...');
                    this.currentUser = { name: 'Test User', email: 'test@example.com' };
                }
                
                this.showScreen('main-screen');
                this.updateUserInfo();
            }
            
            async handleLogout() {
                console.log('üö™ Handling logout...');
                
                if (this.msalInstance && this.currentUser && this.currentUser.account) {
                    try {
                        console.log('Logging out from Entra ID...');
                        await this.msalInstance.logoutPopup();
                        console.log('‚úÖ Entra ID logout successful');
                    } catch (error) {
                        console.error('‚ùå Entra ID logout failed:', error);
                    }
                }
                
                this.currentUser = null;
                this.showScreen('login-screen');
            }
            
            updateUserInfo() {
                console.log('üë§ Updating user info...');
                
                const userNameElement = document.getElementById('user-name');
                if (userNameElement && this.currentUser) {
                    userNameElement.textContent = this.currentUser.name || this.currentUser.email || 'Bruker';
                    console.log('‚úÖ User info updated:', this.currentUser.name);
                }
            }
            
            async testDataverseConnection() {
                console.log('üîó Testing Dataverse connection...');
                
                if (this.dataverseConfig && this.dataverseConfig.mockMode) {
                    console.log('‚úÖ Dataverse connection test successful (mock mode)');
                    return { success: true, message: 'Mock connection successful' };
                } else if (this.dataverseConfig && this.msalInstance) {
                    try {
                        // Get access token for Dataverse
                        const tokenRequest = {
                            scopes: ['https://smittevaksine2022utvikling.crm4.dynamics.com/.default'],
                            account: this.currentUser?.account
                        };
                        
                        const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                        console.log('‚úÖ Access token acquired for Dataverse');
                        
                        // Test real Dataverse connection
                        const response = await fetch(this.dataverseConfig.baseUrl + 'WhoAmI()', {
                            headers: {
                                'Authorization': 'Bearer ' + tokenResponse.accessToken,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Dataverse connection test successful');
                            return { success: true, message: 'Real Dataverse connection successful' };
                        } else {
                            console.log('‚ùå Dataverse connection test failed:', response.status);
                            return { success: false, message: `Connection failed: ${response.status}` };
                        }
                    } catch (error) {
                        console.error('‚ùå Dataverse connection test error:', error);
                        
                        // If token acquisition failed, try interactive login
                        if (error.name === 'InteractionRequiredAuthError') {
                            console.log('üîÑ Token expired, trying interactive login...');
                            try {
                                const tokenResponse = await this.msalInstance.acquireTokenPopup(tokenRequest);
                                console.log('‚úÖ New access token acquired via popup');
                                
                                // Retry Dataverse connection
                                const response = await fetch(this.dataverseConfig.baseUrl + 'WhoAmI()', {
                                    headers: {
                                        'Authorization': 'Bearer ' + tokenResponse.accessToken,
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                if (response.ok) {
                                    console.log('‚úÖ Dataverse connection test successful after re-authentication');
                                    return { success: true, message: 'Real Dataverse connection successful' };
                                }
                            } catch (popupError) {
                                console.error('‚ùå Interactive token acquisition failed:', popupError);
                            }
                        }
                        
                        return { success: false, message: 'Connection error: ' + error.message };
                    }
                } else {
                    console.log('‚ùå Dataverse not configured');
                    return { success: false, message: 'Dataverse not configured' };
                }
            }
            
            async handleAttendanceSubmit() {
                console.log('üíæ Handling attendance form submission...');
                
                try {
                    // Get form data
                    const formData = new FormData(document.getElementById('attendance-form'));
                    const attendanceData = {
                        socio_deltakelse_fra: formData.get('socio_deltakelse_fra'),
                        socio_deltakelse_til: formData.get('socio_deltakelse_til'),
                        socio_type: parseInt(formData.get('socio_type')),
                        socio_status: parseInt(formData.get('socio_status')),
                        socio_beskrivelse: formData.get('socio_beskrivelse') || '',
                        socio_varighet: parseFloat(formData.get('socio_varighet')) || null
                    };
                    
                    console.log('üìù Attendance data:', attendanceData);
                    
                    // Validate required fields
                    if (!attendanceData.socio_deltakelse_fra || !attendanceData.socio_deltakelse_til || !attendanceData.socio_type) {
                        alert('Vennligst fyll ut alle p√•krevde felt.');
                        return;
                    }
                    
                    // Generate socio_id
                    const socio_id = `${attendanceData.socio_type}_${attendanceData.socio_deltakelse_fra}_${Date.now()}`;
                    
                    // Prepare Dataverse payload
                    const payload = {
                        'socio_id': socio_id,
                        'socio_deltakelse_fra': attendanceData.socio_deltakelse_fra,
                        'socio_deltakelse_til': attendanceData.socio_deltakelse_til,
                        'socio_type': attendanceData.socio_type,
                        'socio_status': attendanceData.socio_status,
                        'socio_beskrivelse': attendanceData.socio_beskrivelse
                    };
                    
                    // Add varighet if provided
                    if (attendanceData.socio_varighet !== null) {
                        payload['socio_varighet'] = attendanceData.socio_varighet;
                    }
                    
                    // Note: User reference will be set automatically by Dataverse based on the authenticated user
                    // In a real app, you might want to create a socio_bruker record first and reference it here
                    
                    console.log('üì§ Sending to Dataverse:', payload);
                    
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://smittevaksine2022utvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    
                    // Create attendance record
                    const response = await fetch(this.dataverseConfig.baseUrl + 'socio_Deltakelses', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + tokenResponse.accessToken,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Attendance created successfully:', result);
                        alert('Deltagelse registrert!');
                        this.showScreen('main-screen');
                        document.getElementById('attendance-form').reset();
                    } else {
                        const error = await response.text();
                        console.error('‚ùå Failed to create attendance:', response.status, error);
                        alert(`Feil ved registrering: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Attendance submission error:', error);
                    alert('En feil oppstod ved registrering. Pr√∏v igjen.');
                }
            }
        }
        
        // Initialize app when page loads
        window.addEventListener('load', () => {
            console.log('üåê Window loaded, creating CleanApp...');
            window.cleanApp = new CleanApp();
            window.cleanApp.initialize();
        });
        
        console.log('=== CLEAN APP SCRIPT LOADED ===');
    </script>
</body>
</html>
