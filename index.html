<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FravÃ¦r Registrering - Clean</title>
    <meta name="description" content="App for flyktninger til Ã¥ registrere deltakelse og fravÃ¦r">
    <meta name="theme-color" content="#0078d4">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Punkt CSS Framework -->
    <link href="https://punkt-cdn.oslo.kommune.no/latest/css/pkt.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    
        <!-- MSAL Library - Use real MSAL from CDN with local fallback -->
        <script src="https://unpkg.com/@azure/msal-browser@2.38.4/lib/msal-browser.min.js"
                onload="console.log('âœ… Real MSAL loaded from CDN');"
                onerror="console.error('CDN failed, loading local MSAL...');
                         var script = document.createElement('script');
                         script.src = 'lib/msal-browser-real.min.js';
                         script.onload = function() { console.log('âœ… Real MSAL loaded from local file'); };
                script.onerror = function() {
                             console.log('Loading mock MSAL...');
                             var mockScript = document.createElement('script');
                             mockScript.src = 'lib/msal-browser.min.js';
                             document.head.appendChild(mockScript);
                         };
                         document.head.appendChild(script);"></script>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="screen hidden">
        <div class="login-container pkt-section pkt-section--white">
            <div class="login-header">
                <img src="https://punkt-cdn.oslo.kommune.no/latest/logos/oslologo.svg" 
                     alt="Oslo kommune logo" 
                     class="oslologo" 
                     height="80">
                <h1 class="pkt-txt-36-bold">FravÃ¦r Registrering</h1>
                <p class="pkt-txt-18">For flyktninger</p>
            </div>
            <div class="login-content">
                <button id="login-btn" class="pkt-btn pkt-btn--primary pkt-btn--large">
                    <span class="icon">ğŸ”</span>
                    Logg inn
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <h1 class="pkt-txt-28-bold">FravÃ¦r Registrering</h1>
            <div class="user-info">
                <span id="user-name" class="pkt-txt-16">Bruker</span>
                <button id="logout-btn" class="pkt-btn pkt-btn--secondary">Logg ut</button>
            </div>
        </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <div class="menu-cards">
                <div class="menu-card pkt-section pkt-section--white">
                    <h3 class="pkt-txt-20-bold">Registrer deltakelse</h3>
                    <p class="pkt-txt-16">Meld fravÃ¦r eller deltakelse</p>
                    <button id="register-attendance-btn" class="pkt-btn pkt-btn--primary">Start</button>
                    </div>
                <div class="menu-card pkt-section pkt-section--white">
                    <h3 class="pkt-txt-20-bold">Mine registreringer</h3>
                    <p class="pkt-txt-16">Se og rediger dine registreringer</p>
                    <button id="view-attendance-list-btn" class="pkt-btn pkt-btn--secondary">Ã…pne</button>
                </div>
            </div>
                    </div>
                </div>

    <!-- Attendance Form Screen -->
    <div id="attendance-form-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <button id="back-to-main-btn" class="pkt-btn pkt-btn--secondary">â† Tilbake</button>
            <h1 class="pkt-txt-28-bold">Registrer deltakelse</h1>
                    </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <form id="attendance-form" class="form pkt-section pkt-section--white">
                <div class="form-group">
                    <label for="socio_dato" class="pkt-txt-16-bold">Dato *</label>
                    <input type="date" id="socio_dato" name="socio_dato" class="pkt-input" required>
                    </div>
                
                <div class="form-group">
                    <label for="socio_fra_klokke" class="pkt-txt-16-bold">Fra klokke *</label>
                    <input type="time" id="socio_fra_klokke" name="socio_fra_klokke" class="pkt-input" required>
                </div>

                <div class="form-group">
                    <label for="socio_til_klokke" class="pkt-txt-16-bold">Til klokke *</label>
                    <input type="time" id="socio_til_klokke" name="socio_til_klokke" class="pkt-input" required>
                    </div>

                <div class="form-group">
                    <label for="socio_varighet" class="pkt-txt-16-bold">Varighet (automatisk beregnet)</label>
                    <input type="text" id="socio_varighet" name="socio_varighet" class="pkt-input" readonly>
                    </div>
                
                <div class="form-group">
                    <label for="socio_type" class="pkt-txt-16-bold">Type *</label>
                    <select id="socio_type" name="socio_type" class="pkt-select" required>
                        <option value="">Velg type...</option>
                        <option value="624610000">Tilstede</option>
                        <option value="624610001">FravÃ¦r</option>
                        <option value="624610002">Deltakelse</option>
                        <option value="624610003">Permisjon</option>
                        <option value="624610004">Syk</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="socio_beskrivelse" class="pkt-txt-16-bold">Beskrivelse</label>
                    <textarea id="socio_beskrivelse" name="socio_beskrivelse" 
                              class="pkt-textarea"
                              placeholder="Beskriv deltagelsen..." 
                              maxlength="1000" rows="3"></textarea>
            </div>

                
                <div class="form-actions">
                    <button type="button" id="cancel-form-btn" class="pkt-btn pkt-btn--secondary">Avbryt</button>
                    <button type="submit" id="save-attendance-btn" class="pkt-btn pkt-btn--primary">Lagre</button>
            </div>
            </form>
        </div>
    </div>

    <!-- Attendance List Screen -->
    <div id="attendance-list-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <button id="back-to-main-from-list-btn" class="pkt-btn pkt-btn--secondary">â† Tilbake</button>
            <h1 class="pkt-txt-28-bold">Mine registreringer</h1>
        </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <div id="attendance-list-container" class="pkt-section pkt-section--white">
                <div id="loading-attendance-list" class="loading-message">
                    <p class="pkt-txt-16">Laster registreringer...</p>
                </div>
                <div id="attendance-list" class="attendance-list" style="display: none;">
                    <!-- Attendance records will be populated here -->
                </div>
                <div id="no-attendance-message" class="no-data-message" style="display: none;">
                    <p class="pkt-txt-16">Ingen registreringer funnet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Screen -->
    <div id="edit-attendance-screen" class="screen hidden">
        <div class="screen-header pkt-section pkt-section--white">
            <button id="back-to-list-btn" class="pkt-btn pkt-btn--secondary">â† Tilbake</button>
            <h1 class="pkt-txt-28-bold">Rediger registrering</h1>
        </div>
        <div class="screen-content pkt-section pkt-section--grey">
            <form id="edit-attendance-form" class="form pkt-section pkt-section--white">
                <div id="edit-status-warning" class="status-warning" style="display: none;">
                    <p class="pkt-txt-16-bold">âš ï¸ Denne registreringen kan ikke endres fordi den er godkjent eller avslÃ¥tt.</p>
                </div>
                
                <div class="form-group">
                    <label for="edit_socio_dato" class="pkt-txt-16-bold">Dato *</label>
                    <input type="date" id="edit_socio_dato" name="socio_dato" class="pkt-input" required>
                </div>

                <div class="form-group">
                    <label for="edit_socio_fra_klokke" class="pkt-txt-16-bold">Fra klokke *</label>
                    <input type="time" id="edit_socio_fra_klokke" name="socio_fra_klokke" class="pkt-input" required>
                </div>

                <div class="form-group">
                    <label for="edit_socio_til_klokke" class="pkt-txt-16-bold">Til klokke *</label>
                    <input type="time" id="edit_socio_til_klokke" name="socio_til_klokke" class="pkt-input" required>
            </div>

                <div class="form-group">
                    <label for="edit_socio_varighet" class="pkt-txt-16-bold">Varighet (automatisk beregnet)</label>
                    <input type="text" id="edit_socio_varighet" name="socio_varighet" class="pkt-input" readonly>
        </div>
                
                <div class="form-group">
                    <label for="edit_socio_type" class="pkt-txt-16-bold">Type *</label>
                    <select id="edit_socio_type" name="socio_type" class="pkt-select" required>
                        <option value="">Velg type...</option>
                        <option value="624610000">Tilstede</option>
                        <option value="624610001">FravÃ¦r</option>
                        <option value="624610002">Deltakelse</option>
                        <option value="624610003">Permisjon</option>
                        <option value="624610004">Syk</option>
                    </select>
    </div>

                <div class="form-group">
                    <label for="edit_socio_beskrivelse" class="pkt-txt-16-bold">Beskrivelse</label>
                    <textarea id="edit_socio_beskrivelse" name="socio_beskrivelse" 
                              class="pkt-textarea"
                              placeholder="Beskriv deltagelsen..." 
                              maxlength="1000" rows="3"></textarea>
        </div>

                <div class="form-group">
                    <label class="pkt-txt-16-bold">Status</label>
                    <div id="edit_socio_status_display" class="status-display pkt-txt-16"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-edit-btn" class="pkt-btn pkt-btn--secondary">Avbryt</button>
                    <button type="submit" id="update-attendance-btn" class="pkt-btn pkt-btn--primary" disabled>Oppdater</button>
                </div>
            </form>
            </div>
        </div>


    <!-- Simple App Script -->
    <script>
        console.log('=== CLEAN APP STARTING ===');
        console.log('Timestamp:', new Date().toISOString());
        
        class CleanApp {
            constructor() {
                console.log('ğŸš€ CleanApp constructor called');
                this.currentScreen = 'login-screen';
                this.initialized = false;
                this.msalInstance = null;
                this.currentUser = null;
            }
            
            async initialize() {
                if (this.initialized) {
                    console.log('App already initialized, skipping...');
                    return;
                }
                
                console.log('ğŸ”§ Initializing CleanApp...');
                this.initialized = true;
                
                // Initialize MSAL
                await this.initializeMSAL();
                
                // Initialize Service Worker
                await this.initializeServiceWorker();
                
                // Initialize Dataverse
                await this.initializeDataverse();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Set default date to today
                this.setDefaultDate();
                
                // Check if user is already authenticated
                if (this.isAuthenticated()) {
                    console.log('âœ… User already authenticated, showing main screen');
                    this.showScreen('main-screen');
                } else {
                    console.log('ğŸ“± User not authenticated, showing login screen');
                    this.showScreen('login-screen');
                }
                
                console.log('âœ… CleanApp initialized successfully');
            }
            
            setDefaultDate() {
                console.log('ğŸ“… Setting default date to today...');
                const today = new Date();
                const todayString = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
                
                // Set default date for main form
                const dateInput = document.getElementById('socio_dato');
                if (dateInput) {
                    dateInput.value = todayString;
                    console.log('âœ… Default date set for main form:', todayString);
                }
                
                // Set default date for edit form
                const editDateInput = document.getElementById('edit_socio_dato');
                if (editDateInput) {
                    editDateInput.value = todayString;
                    console.log('âœ… Default date set for edit form:', todayString);
                }
            }
            
            isAuthenticated() {
                // Check if user is properly authenticated
                const hasUser = this.currentUser && this.currentUser.name;
                const hasMSALAccount = this.msalInstance && this.msalInstance.getAllAccounts().length > 0;
                
                console.log('ğŸ” Authentication check:', {
                    hasUser,
                    hasMSALAccount,
                    currentUser: this.currentUser,
                    msalInstance: !!this.msalInstance
                });
                
                return hasUser || hasMSALAccount;
            }
            
            isMobileDevice() {
                // Check if device is mobile (iPhone, iPad, Android)
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
                console.log('ğŸ“± Mobile device check:', { userAgent, isMobile });
                return isMobile;
            }
            
            async initializeMSAL() {
                console.log('ğŸ” Initializing MSAL...');
                
                // Wait a bit for the script to load
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (typeof msal === 'undefined' || !msal.PublicClientApplication) {
                    console.log('âš ï¸ Real MSAL not available, using mock authentication');
                    return;
                }
                
                console.log('âœ… Real Microsoft MSAL detected');
                
                try {
                    // Real Entra ID configuration from CONFIG
                    const msalConfig = {
                        auth: {
                            clientId: 'c25b351f-417b-46cf-b736-2970d45273fc',
                            authority: 'https://login.microsoftonline.com/fb7e0b12-d8fc-4f14-bd1a-ad9c8667a7e6',
                            redirectUri: window.location.origin
                        },
                        cache: {
                            cacheLocation: 'localStorage',
                            storeAuthStateInCookie: true // Enable for iOS Safari
                        },
                        system: {
                            allowNativeBroker: false, // Disable native broker for better iOS compatibility
                            loggerOptions: {
                                loggerCallback: (level, message, containsPii) => {
                                    if (containsPii) return;
                                    console.log(`MSAL ${level}: ${message}`);
                                },
                                piiLoggingEnabled: false,
                                logLevel: 'Info'
                            }
                        }
                    };
                    
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    
                    // Handle redirect promise (important for mobile devices)
                    const redirectResponse = await this.msalInstance.handleRedirectPromise();
                    if (redirectResponse) {
                        console.log('âœ… Redirect login successful:', redirectResponse);
                        this.currentUser = {
                            name: redirectResponse.account.name,
                            email: redirectResponse.account.username,
                            account: redirectResponse.account
                        };
                        this.updateUserInfo();
                        // Don't show screen here, let the main initialization handle it
                    }
                    
                    console.log('âœ… MSAL initialized successfully with Entra ID');
                } catch (error) {
                    console.error('âŒ MSAL initialization failed:', error);
                    console.log('Falling back to mock authentication');
                }
            }
            
            async initializeServiceWorker() {
                console.log('ğŸ”§ Initializing Service Worker...');
                
                if (!('serviceWorker' in navigator)) {
                    console.log('Service Worker not supported');
                    return;
                }
                
                if (window.serviceWorkerRegistered) {
                    console.log('Service Worker already registered');
                    return;
                }
                
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('âœ… Service Worker registered successfully:', registration);
                    window.serviceWorkerRegistered = true;
                } catch (error) {
                    console.error('âŒ Service Worker registration failed:', error);
                }
            }
            
            async initializeDataverse() {
                console.log('ğŸ—„ï¸ Initializing Dataverse...');
                
                try {
                    // Real Dataverse configuration from CONFIG
                    this.dataverseConfig = {
                        baseUrl: 'https://flyktningportalenutvikling.crm4.dynamics.com/api/data/v9.2/',
                        apiVersion: '9.2',
                        entities: {
                            user: 'new_bruker',
                            participation: 'new_deltakelse',
                            absence: 'new_fravÃ¦r'
                        },
                        mockMode: false // Set to true for offline development
                    };
                    
                    console.log('âœ… Dataverse initialized successfully');
                } catch (error) {
                    console.error('âŒ Dataverse initialization failed:', error);
                }
            }
            
            showScreen(screenId) {
                console.log('ğŸ“± Showing screen:', screenId);
                
                // Security check: prevent access to protected screens without authentication
                const protectedScreens = ['main-screen', 'attendance-form-screen', 'attendance-list-screen', 'edit-attendance-screen'];
                if (protectedScreens.includes(screenId) && !this.isAuthenticated()) {
                    console.log('ğŸš« Access denied to protected screen without authentication:', screenId);
                    this.showScreen('login-screen');
                    return;
                }
                
                // Hide all screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                });
                
                // Show target screen
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.style.display = 'flex';
                    this.currentScreen = screenId;
                    console.log('âœ… Screen shown:', screenId);
                    
                    // Set default date when showing attendance form
                    if (screenId === 'attendance-form-screen') {
                        this.setDefaultDate();
                    }
                } else {
                    console.error('âŒ Screen not found:', screenId);
                }
            }
            
            setupEventListeners() {
                console.log('ğŸ”— Setting up event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        console.log('ğŸ” Login button clicked');
                        this.handleLogin();
                    });
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log('ğŸšª Logout button clicked');
                        this.handleLogout();
                    });
                }
                
                
                // Register attendance button
                const registerAttendanceBtn = document.getElementById('register-attendance-btn');
                if (registerAttendanceBtn) {
                    registerAttendanceBtn.addEventListener('click', () => {
                        console.log('ğŸ“ Register attendance button clicked');
                        if (!this.isAuthenticated()) {
                            console.log('ğŸš« Access denied - not authenticated');
                            this.showScreen('login-screen');
                            return;
                        }
                        this.showScreen('attendance-form-screen');
                    });
                }
                
                // Back to main button
                const backToMainBtn = document.getElementById('back-to-main-btn');
                if (backToMainBtn) {
                    backToMainBtn.addEventListener('click', () => {
                        console.log('â† Back to main button clicked');
                        this.showScreen('main-screen');
                    });
                }
                
                // Cancel form button
                const cancelFormBtn = document.getElementById('cancel-form-btn');
                if (cancelFormBtn) {
                    cancelFormBtn.addEventListener('click', () => {
                        console.log('âŒ Cancel form button clicked');
                        this.showScreen('main-screen');
                    });
                }
                
                // Attendance form submit
                const attendanceForm = document.getElementById('attendance-form');
                if (attendanceForm) {
                    attendanceForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        console.log('ğŸ’¾ Attendance form submitted');
                        await this.handleAttendanceSubmit();
                    });
                }
                
                // Auto-calculate duration when time inputs change
                const fromTimeInput = document.getElementById('socio_fra_klokke');
                const toTimeInput = document.getElementById('socio_til_klokke');
                const durationInput = document.getElementById('socio_varighet');
                const saveButton = document.getElementById('save-attendance-btn');
                
                if (fromTimeInput && toTimeInput && durationInput && saveButton) {
                    const calculateDuration = () => {
                        const fromTime = fromTimeInput.value;
                        const toTime = toTimeInput.value;
                        
                        if (fromTime && toTime) {
                            const from = new Date(`2000-01-01T${fromTime}`);
                            const to = new Date(`2000-01-01T${toTime}`);
                            const diffMs = to - from;
                            
                            if (diffMs > 0) {
                                const diffHours = diffMs / (1000 * 60 * 60);
                                durationInput.value = `${diffHours.toFixed(1)} timer`;
                            } else {
                                durationInput.value = 'Ugyldig tidsperiode';
                            }
                        } else {
                            durationInput.value = '';
                        }
                        
                        // Validate form and enable/disable save button
                        validateForm();
                    };
                    
                    const validateForm = () => {
                        const requiredFields = [
                            document.getElementById('socio_dato'),
                            document.getElementById('socio_fra_klokke'),
                            document.getElementById('socio_til_klokke'),
                            document.getElementById('socio_type')
                        ];
                        
                        const allFieldsFilled = requiredFields.every(field => field && field.value.trim() !== '');
                        const validTimeRange = fromTimeInput.value && toTimeInput.value && 
                                             new Date(`2000-01-01T${toTimeInput.value}`) > new Date(`2000-01-01T${fromTimeInput.value}`);
                        
                        if (allFieldsFilled && validTimeRange) {
                            saveButton.disabled = false;
                            saveButton.textContent = 'Lagre';
                        } else {
                            saveButton.disabled = true;
                            saveButton.textContent = 'Fyll ut alle pÃ¥krevde felt';
                        }
                    };
                    
                    fromTimeInput.addEventListener('change', calculateDuration);
                    toTimeInput.addEventListener('change', calculateDuration);
                    
                    // Add validation to all required fields
                    const requiredFields = [
                        document.getElementById('socio_dato'),
                        document.getElementById('socio_fra_klokke'),
                        document.getElementById('socio_til_klokke'),
                        document.getElementById('socio_type')
                    ];
                    
                    requiredFields.forEach(field => {
                        if (field) {
                            field.addEventListener('change', validateForm);
                            field.addEventListener('input', validateForm);
                        }
                    });
                    
                    // Initial validation
                    validateForm();
                }
                
                // View attendance list button
                const viewAttendanceListBtn = document.getElementById('view-attendance-list-btn');
                if (viewAttendanceListBtn) {
                    viewAttendanceListBtn.addEventListener('click', () => {
                        console.log('ğŸ“‹ View attendance list button clicked');
                        if (!this.isAuthenticated()) {
                            console.log('ğŸš« Access denied - not authenticated');
                            this.showScreen('login-screen');
                            return;
                        }
                        this.showAttendanceList();
                    });
                }
                
                
                // Back to main from list button
                const backToMainFromListBtn = document.getElementById('back-to-main-from-list-btn');
                if (backToMainFromListBtn) {
                    backToMainFromListBtn.addEventListener('click', () => {
                        console.log('â† Back to main from list button clicked');
                        this.showScreen('main-screen');
                    });
                }
                
                // Back to list button (from edit screen)
                const backToListBtn = document.getElementById('back-to-list-btn');
                if (backToListBtn) {
                    backToListBtn.addEventListener('click', () => {
                        console.log('â† Back to list button clicked');
                        this.showScreen('attendance-list-screen');
                    });
                }
                
                // Cancel edit button
                const cancelEditBtn = document.getElementById('cancel-edit-btn');
                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', () => {
                        console.log('âŒ Cancel edit button clicked');
                        this.showScreen('attendance-list-screen');
                    });
                }
                
                // Edit attendance form submit
                const editAttendanceForm = document.getElementById('edit-attendance-form');
                if (editAttendanceForm) {
                    editAttendanceForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        console.log('ğŸ’¾ Edit attendance form submitted');
                        await this.handleEditAttendanceSubmit();
                    });
                }
                
                // Auto-calculate duration for edit form
                const editFromTimeInput = document.getElementById('edit_socio_fra_klokke');
                const editToTimeInput = document.getElementById('edit_socio_til_klokke');
                const editDurationInput = document.getElementById('edit_socio_varighet');
                const editUpdateButton = document.getElementById('update-attendance-btn');
                
                if (editFromTimeInput && editToTimeInput && editDurationInput && editUpdateButton) {
                    const calculateEditDuration = () => {
                        const fromTime = editFromTimeInput.value;
                        const toTime = editToTimeInput.value;
                        
                        if (fromTime && toTime) {
                            const from = new Date(`2000-01-01T${fromTime}`);
                            const to = new Date(`2000-01-01T${toTime}`);
                            const diffMs = to - from;
                            
                            if (diffMs > 0) {
                                const diffHours = diffMs / (1000 * 60 * 60);
                                editDurationInput.value = `${diffHours.toFixed(1)} timer`;
                            } else {
                                editDurationInput.value = 'Ugyldig tidsperiode';
                            }
                        } else {
                            editDurationInput.value = '';
                        }
                        
                        // Validate edit form and enable/disable update button
                        validateEditForm();
                    };
                    
                    const validateEditForm = () => {
                        const requiredFields = [
                            document.getElementById('edit_socio_dato'),
                            document.getElementById('edit_socio_fra_klokke'),
                            document.getElementById('edit_socio_til_klokke'),
                            document.getElementById('edit_socio_type')
                        ];
                        
                        const allFieldsFilled = requiredFields.every(field => field && field.value.trim() !== '');
                        const validTimeRange = editFromTimeInput.value && editToTimeInput.value && 
                                             new Date(`2000-01-01T${editToTimeInput.value}`) > new Date(`2000-01-01T${editFromTimeInput.value}`);
                        
                        if (allFieldsFilled && validTimeRange) {
                            editUpdateButton.disabled = false;
                            editUpdateButton.textContent = 'Oppdater';
                        } else {
                            editUpdateButton.disabled = true;
                            editUpdateButton.textContent = 'Fyll ut alle pÃ¥krevde felt';
                        }
                    };
                    
                    editFromTimeInput.addEventListener('change', calculateEditDuration);
                    editToTimeInput.addEventListener('change', calculateEditDuration);
                    
                    const editRequiredFields = [
                        document.getElementById('edit_socio_dato'),
                        document.getElementById('edit_socio_fra_klokke'),
                        document.getElementById('edit_socio_til_klokke'),
                        document.getElementById('edit_socio_type')
                    ];
                    
                    editRequiredFields.forEach(field => {
                        if (field) {
                            field.addEventListener('change', validateEditForm);
                            field.addEventListener('input', validateEditForm);
                        }
                    });
                    
                    // Initial validation
                    validateEditForm();
                }
                
                console.log('âœ… Event listeners set up');
            }
            
            async handleLogin() {
                console.log('ğŸ” Handling login...');
                
                if (this.msalInstance) {
                    try {
                        console.log('Using MSAL for Entra ID authentication...');
                        
                        // Check if user is already logged in
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            console.log('User already logged in:', accounts[0]);
                            this.currentUser = {
                                name: accounts[0].name,
                                email: accounts[0].username,
                                account: accounts[0]
                            };
                            this.updateUserInfo();
                            this.showScreen('main-screen');
                            return;
                        }
                        
                        // Login request with Dataverse scope
                        const loginRequest = {
                            scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                            prompt: 'select_account'
                        };
                        
                        // Use redirect for mobile devices, popup for desktop
                        if (this.isMobileDevice()) {
                            console.log('ğŸ“± Mobile device detected, using redirect login...');
                            await this.msalInstance.loginRedirect(loginRequest);
                            // Note: This will redirect the page, so we won't reach the code below
                            return;
                        } else {
                            console.log('ğŸ–¥ï¸ Desktop device detected, using popup login...');
                            const response = await this.msalInstance.loginPopup(loginRequest);
                            console.log('âœ… Entra ID login successful:', response);
                            
                            this.currentUser = {
                                name: response.account.name,
                                email: response.account.username,
                                account: response.account
                            };
                            
                            // Update user info immediately after login
                            this.updateUserInfo();
                            
                            // Show main screen only after successful authentication
                            this.showScreen('main-screen');
                        }
                        
                    } catch (error) {
                        console.error('âŒ Entra ID login failed:', error);
                        console.log('Falling back to mock authentication');
                        this.currentUser = { name: 'Test User', email: 'test@example.com' };
                        this.updateUserInfo();
                        this.showScreen('main-screen');
                    }
                } else {
                    console.log('Using mock authentication...');
                    this.currentUser = { name: 'Test User', email: 'test@example.com' };
                    this.updateUserInfo();
                    this.showScreen('main-screen');
                }
            }
            
            async handleLogout() {
                console.log('ğŸšª Handling logout...');
                
                if (this.msalInstance && this.currentUser && this.currentUser.account) {
                    try {
                        console.log('Logging out from Entra ID...');
                        
                        // Use redirect for mobile devices, popup for desktop
                        if (this.isMobileDevice()) {
                            console.log('ğŸ“± Mobile device detected, using redirect logout...');
                            await this.msalInstance.logoutRedirect();
                            // Note: This will redirect the page, so we won't reach the code below
                            return;
                        } else {
                            console.log('ğŸ–¥ï¸ Desktop device detected, using popup logout...');
                            await this.msalInstance.logoutPopup();
                            console.log('âœ… Entra ID logout successful');
                        }
                    } catch (error) {
                        console.error('âŒ Entra ID logout failed:', error);
                    }
                }
                
                this.currentUser = null;
                this.showScreen('login-screen');
            }
            
            updateUserInfo() {
                console.log('ğŸ‘¤ Updating user info...');
                console.log('ğŸ‘¤ Current user:', this.currentUser);
                
                const userNameElement = document.getElementById('user-name');
                if (userNameElement && this.currentUser) {
                    const displayName = this.currentUser.name || this.currentUser.email || 'Bruker';
                    userNameElement.textContent = displayName;
                    console.log('âœ… User info updated:', displayName);
                } else {
                    console.log('âŒ User info not updated - missing element or user:', {
                        userNameElement: !!userNameElement,
                        currentUser: !!this.currentUser
                    });
                }
            }
            
            async testDataverseConnection() {
                console.log('ğŸ”— Testing Dataverse connection...');
                
                if (this.dataverseConfig && this.dataverseConfig.mockMode) {
                    console.log('âœ… Dataverse connection test successful (mock mode)');
                    return { success: true, message: 'Mock connection successful' };
                } else if (this.dataverseConfig && this.msalInstance) {
                    try {
                        // Get access token for Dataverse
                        const tokenRequest = {
                            scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                            account: this.currentUser?.account
                        };
                        
                        const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                        console.log('âœ… Access token acquired for Dataverse');
                        
                        // Test real Dataverse connection
                        const response = await fetch(this.dataverseConfig.baseUrl + 'WhoAmI()', {
                            headers: {
                                'Authorization': 'Bearer ' + tokenResponse.accessToken,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            console.log('âœ… Dataverse connection test successful');
                            return { success: true, message: 'Real Dataverse connection successful' };
                        } else {
                            console.log('âŒ Dataverse connection test failed:', response.status);
                            return { success: false, message: `Connection failed: ${response.status}` };
                        }
                    } catch (error) {
                        console.error('âŒ Dataverse connection test error:', error);
                        
                        // If token acquisition failed, try interactive login
                        if (error.name === 'InteractionRequiredAuthError') {
                            console.log('ğŸ”„ Token expired, trying interactive login...');
                            try {
                                const tokenResponse = await this.msalInstance.acquireTokenPopup(tokenRequest);
                                console.log('âœ… New access token acquired via popup');
                                
                                // Retry Dataverse connection
                                const response = await fetch(this.dataverseConfig.baseUrl + 'WhoAmI()', {
                                    headers: {
                                        'Authorization': 'Bearer ' + tokenResponse.accessToken,
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                if (response.ok) {
                                    console.log('âœ… Dataverse connection test successful after re-authentication');
                                    return { success: true, message: 'Real Dataverse connection successful' };
                                }
                            } catch (popupError) {
                                console.error('âŒ Interactive token acquisition failed:', popupError);
                            }
                        }
                        
                        return { success: false, message: 'Connection error: ' + error.message };
                    }
                } else {
                    console.log('âŒ Dataverse not configured');
                    return { success: false, message: 'Dataverse not configured' };
                }
            }
            
            async handleAttendanceSubmit() {
                console.log('ğŸ’¾ Handling attendance form submission...');
                
                try {
                    // Get form data
                    const formData = new FormData(document.getElementById('attendance-form'));
                    const attendanceData = {
                        socio_dato: formData.get('socio_dato'),
                        socio_fra_klokke: formData.get('socio_fra_klokke'),
                        socio_til_klokke: formData.get('socio_til_klokke'),
                        socio_type: parseInt(formData.get('socio_type')),
                        socio_beskrivelse: formData.get('socio_beskrivelse') || '',
                        socio_varighet: formData.get('socio_varighet') || ''
                    };
                    
                    console.log('ğŸ“ Attendance data:', attendanceData);
                    
                    // Validate required fields
                    if (!attendanceData.socio_dato || !attendanceData.socio_fra_klokke || !attendanceData.socio_til_klokke || !attendanceData.socio_type) {
                        alert('Vennligst fyll ut alle pÃ¥krevde felt.');
                        return;
                    }
                    
                    // Generate socio_id
                    const socio_id = `${attendanceData.socio_type}_${attendanceData.socio_dato}_${Date.now()}`;
                    
                    // Calculate duration in hours as a number
                    let durationHours = 0;
                    if (attendanceData.socio_fra_klokke && attendanceData.socio_til_klokke) {
                        const from = new Date(`2000-01-01T${attendanceData.socio_fra_klokke}`);
                        const to = new Date(`2000-01-01T${attendanceData.socio_til_klokke}`);
                        const diffMs = to - from;
                        durationHours = diffMs / (1000 * 60 * 60);
                    }
                    
                    // Prepare Dataverse payload with correct field names and option set values
                    const payload = {
                        'socio_deltagelse_fra': attendanceData.socio_dato + 'T' + attendanceData.socio_fra_klokke + ':00',
                        'socio_deltagelse_til': attendanceData.socio_dato + 'T' + attendanceData.socio_til_klokke + ':00',
                        'socio_beskrivelse': attendanceData.socio_beskrivelse || null,
                        'socio_registeringstatus': 624610000, // Default to "Registrert" (option set value)
                        'socio_typedeltagelse': parseInt(attendanceData.socio_type),
                        'socio_varighet': durationHours
                    };
                    
                    // Add type and status only if they exist in Dataverse
                    // We'll need to check the actual field names from Dataverse metadata
                    console.log('ğŸ” Sending minimal payload to test field names:', payload);
                    
                    // Skip metadata fetching for now and try to create record directly
                    console.log('ğŸ” Skipping metadata fetch, trying direct record creation...');
                    
                    // Remove null/empty values to avoid issues
                    Object.keys(payload).forEach(key => {
                        if (payload[key] === null || payload[key] === undefined || payload[key] === '') {
                            delete payload[key];
                        }
                    });
                    
                    // Note: User reference will be set automatically by Dataverse based on the authenticated user
                    // In a real app, you might want to create a socio_bruker record first and reference it here
                    
                    console.log('ğŸ“¤ Sending to Dataverse:', payload);
                    console.log('ğŸ“¤ Payload keys:', Object.keys(payload));
                    console.log('ğŸ“¤ Payload values:', Object.values(payload));
                    console.log('ğŸ”— Dataverse URL:', this.dataverseConfig.baseUrl + 'socio_deltakelses');
                    
                    // First, let's check what fields actually exist in the entity
                    try {
                        const metadataUrl = this.dataverseConfig.baseUrl + '$metadata#EntityDefinitions';
                        console.log('ğŸ” Checking entity metadata...');
                        // We'll add this check after the main request
                    } catch (metadataError) {
                        console.log('âš ï¸ Could not check metadata:', metadataError);
                    }
                    
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    console.log('ğŸ”‘ Access token acquired');
                    
                    // First, let's test if the entity exists by trying to get metadata
                    console.log('ğŸ” Testing entity existence...');
                    const metadataResponse = await fetch(this.dataverseConfig.baseUrl + '$metadata#EntityDefinitions', {
                        headers: {
                            'Authorization': 'Bearer ' + tokenResponse.accessToken,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (metadataResponse.ok) {
                        console.log('âœ… Metadata accessible');
                    } else {
                        console.log('âŒ Metadata not accessible:', metadataResponse.status);
                    }
                    
                    // Create attendance record
                    const response = await fetch(this.dataverseConfig.baseUrl + 'socio_deltakelses', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + tokenResponse.accessToken,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        // Check if response has content before parsing
                        const responseText = await response.text();
                        console.log('ğŸ“„ Response text:', responseText);
                        
                        if (responseText.trim()) {
                            try {
                                const result = JSON.parse(responseText);
                                console.log('âœ… Attendance created successfully:', result);
                            } catch (parseError) {
                                console.log('âœ… Attendance created successfully (non-JSON response)');
                            }
                        } else {
                            console.log('âœ… Attendance created successfully (empty response)');
                        }
                        
                        alert('Deltagelse registrert!');
                        this.showScreen('main-screen');
                        document.getElementById('attendance-form').reset();
                    } else {
                        const error = await response.text();
                        console.error('âŒ Failed to create attendance:', response.status, error);
                        alert(`Feil ved registrering: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ Attendance submission error:', error);
                    alert('En feil oppstod ved registrering. PrÃ¸v igjen.');
                }
            }
            
            async showAttendanceList() {
                console.log('ğŸ“‹ Showing attendance list...');
                this.showScreen('attendance-list-screen');
                
                // Show loading state
                document.getElementById('loading-attendance-list').style.display = 'block';
                document.getElementById('attendance-list').style.display = 'none';
                document.getElementById('no-attendance-message').style.display = 'none';
                
                try {
                    // Get attendance records from Dataverse
                    const records = await this.fetchAttendanceRecords();
                    
                    if (records && records.length > 0) {
                        this.displayAttendanceList(records);
                    } else {
                        document.getElementById('loading-attendance-list').style.display = 'none';
                        document.getElementById('no-attendance-message').style.display = 'block';
                    }
                } catch (error) {
                    console.error('âŒ Error fetching attendance records:', error);
                    document.getElementById('loading-attendance-list').style.display = 'none';
                    document.getElementById('no-attendance-message').style.display = 'block';
                    alert('Kunne ikke laste registreringer. PrÃ¸v igjen.');
                }
            }
            
            async fetchAttendanceRecords() {
                console.log('ğŸ” Fetching attendance records...');
                
                if (!this.dataverseConfig) {
                    console.log('âŒ Dataverse not configured');
                    return [];
                }
                
                try {
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    const accessToken = tokenResponse.accessToken;
                    
                    // Fetch records
                    const response = await fetch(this.dataverseConfig.baseUrl + 'socio_deltakelses', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json',
                            'OData-MaxVersion': '4.0',
                            'OData-Version': '4.0'
                        }
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        if (responseText.trim()) {
                            try {
                                const data = JSON.parse(responseText);
                                console.log('âœ… Attendance records fetched:', data);
                                return data.value || [];
                            } catch (parseError) {
                                console.error('âŒ Failed to parse attendance records:', parseError);
                                return [];
                            }
                        } else {
                            console.log('âœ… No attendance records found (empty response)');
                            return [];
                        }
                    } else {
                        console.error('âŒ Failed to fetch attendance records:', response.status);
                        return [];
                    }
                    
                } catch (error) {
                    console.error('âŒ Error fetching attendance records:', error);
                    return [];
                }
            }
            
            displayAttendanceList(records) {
                console.log('ğŸ“‹ Displaying attendance list...');
                
                const listContainer = document.getElementById('attendance-list');
                listContainer.innerHTML = '';
                
                records.forEach(record => {
                    const recordElement = this.createAttendanceRecordElement(record);
                    listContainer.appendChild(recordElement);
                });
                
                document.getElementById('loading-attendance-list').style.display = 'none';
                document.getElementById('attendance-list').style.display = 'block';
            }
            
            createAttendanceRecordElement(record) {
                const div = document.createElement('div');
                div.className = 'attendance-record pkt-section pkt-section--white';
                div.style.marginBottom = '10px';
                div.style.padding = '15px';
                div.style.border = '1px solid #e1dfdd';
                div.style.borderRadius = '4px';
                
                // Parse dates
                const fromDate = record.socio_deltagelse_fra ? new Date(record.socio_deltagelse_fra) : null;
                const toDate = record.socio_deltagelse_til ? new Date(record.socio_deltagelse_til) : null;
                
                // Format date and time
                const dateStr = fromDate ? fromDate.toLocaleDateString('nb-NO') : 'Ukjent dato';
                const fromTimeStr = fromDate ? fromDate.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' }) : 'Ukjent';
                const toTimeStr = toDate ? toDate.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' }) : 'Ukjent';
                
                // Get type name using correct option set values
                const typeNames = {
                    624610000: 'Tilstede',
                    624610001: 'FravÃ¦r', 
                    624610002: 'Deltakelse',
                    624610003: 'Permisjon',
                    624610004: 'Syk'
                };
                const typeName = typeNames[record.socio_typedeltagelse] || 'Ukjent';
                
                // Get status name using correct option set values
                const statusNames = {
                    624610000: 'Registrert',
                    624610001: 'Godkjent',
                    624610002: 'AvslÃ¥tt'
                };
                const statusName = statusNames[record.socio_registeringstatus] || 'Ukjent';
                const statusClass = record.socio_registeringstatus === 624610001 ? 'status-approved' : 
                                  record.socio_registeringstatus === 624610002 ? 'status-rejected' : 'status-registered';
                
                // Check if record can be edited
                const canEdit = record.socio_registeringstatus === 624610000; // Only "Registrert" can be edited
                
                div.innerHTML = `
                    <div class="record-header">
                        <h4 class="pkt-txt-18-bold">${typeName} - ${dateStr}</h4>
                        <span class="status-badge ${statusClass} pkt-txt-14">${statusName}</span>
    </div>
                    <div class="record-details pkt-txt-16">
                        <p><strong>Tid:</strong> ${fromTimeStr} - ${toTimeStr}</p>
                        <p><strong>Varighet:</strong> ${record.socio_varighet ? record.socio_varighet.toFixed(1) + ' timer' : 'Ukjent'}</p>
                        ${record.socio_beskrivelse ? `<p><strong>Beskrivelse:</strong> ${record.socio_beskrivelse}</p>` : ''}
                    </div>
                    <div class="record-actions">
                        <div class="action-buttons">
                            ${canEdit ? 
                                `<button class="edit-record-btn pkt-btn pkt-btn--secondary" data-record-id="${record.socio_deltakelseid}">Rediger</button>` :
                                `<span class="pkt-txt-14" style="color: #666;">Kan ikke redigeres (${statusName})</span>`
                            }
                            ${canEdit ? 
                                `<button class="delete-record-btn pkt-btn pkt-btn--danger" data-record-id="${record.socio_deltakelseid}">Slett</button>` :
                                ''
                            }
                        </div>
                    </div>
                `;
                
                // Add edit and delete button event listeners
                if (canEdit) {
                    const editBtn = div.querySelector('.edit-record-btn');
                    editBtn.addEventListener('click', () => {
                        this.editAttendanceRecord(record);
                    });
                    
                    const deleteBtn = div.querySelector('.delete-record-btn');
                    deleteBtn.addEventListener('click', () => {
                        this.deleteAttendanceRecord(record);
                    });
                }
                
                return div;
            }
            
            editAttendanceRecord(record) {
                console.log('âœï¸ Editing attendance record:', record);
                
                // Parse dates
                const fromDate = record.socio_deltagelse_fra ? new Date(record.socio_deltagelse_fra) : null;
                const toDate = record.socio_deltagelse_til ? new Date(record.socio_deltagelse_til) : null;
                
                // Populate edit form
                if (fromDate) {
                    document.getElementById('edit_socio_dato').value = fromDate.toISOString().split('T')[0];
                    document.getElementById('edit_socio_fra_klokke').value = fromDate.toTimeString().slice(0, 5);
                }
                
                if (toDate) {
                    document.getElementById('edit_socio_til_klokke').value = toDate.toTimeString().slice(0, 5);
                }
                
                document.getElementById('edit_socio_type').value = record.socio_typedeltagelse || '';
                document.getElementById('edit_socio_beskrivelse').value = record.socio_beskrivelse || '';
                
                // Show status using correct option set values
                const statusNames = {
                    624610000: 'Registrert',
                    624610001: 'Godkjent', 
                    624610002: 'AvslÃ¥tt'
                };
                const statusName = statusNames[record.socio_registeringstatus] || 'Ukjent';
                document.getElementById('edit_socio_status_display').textContent = statusName;
                
                // Check if can edit
                const canEdit = record.socio_registeringstatus === 624610000;
                const warningDiv = document.getElementById('edit-status-warning');
                const form = document.getElementById('edit-attendance-form');
                
                if (canEdit) {
                    warningDiv.style.display = 'none';
                    form.querySelectorAll('input, select, textarea').forEach(field => {
                        field.disabled = false;
                    });
                } else {
                    warningDiv.style.display = 'block';
                    form.querySelectorAll('input, select, textarea').forEach(field => {
                        field.disabled = true;
                    });
                }
                
                // Store record ID for update
                this.currentEditRecordId = record.socio_deltakelseid;
                
                // Calculate duration
                const editFromTimeInput = document.getElementById('edit_socio_fra_klokke');
                const editToTimeInput = document.getElementById('edit_socio_til_klokke');
                if (editFromTimeInput.value && editToTimeInput.value) {
                    const from = new Date(`2000-01-01T${editFromTimeInput.value}`);
                    const to = new Date(`2000-01-01T${editToTimeInput.value}`);
                    const diffMs = to - from;
                    const diffHours = diffMs / (1000 * 60 * 60);
                    document.getElementById('edit_socio_varighet').value = `${diffHours.toFixed(1)} timer`;
                }
                
                this.showScreen('edit-attendance-screen');
            }
            
            async deleteAttendanceRecord(record) {
                console.log('ğŸ—‘ï¸ Deleting attendance record:', record);
                
                // Show confirmation popup
                const typeName = record.socio_typedeltagelse ? this.getTypeName(record.socio_typedeltagelse) : 'Ukjent type';
                const dateStr = record.socio_deltagelse_fra ? new Date(record.socio_deltagelse_fra).toLocaleDateString('nb-NO') : 'Ukjent dato';
                
                const confirmMessage = `Er du sikker pÃ¥ at du vil slette denne registreringen?\n\n${typeName} - ${dateStr}`;
                console.log('ğŸ“± Showing confirmation popup...');
                
                if (confirm(confirmMessage)) {
                    console.log('âœ… Delete confirmed, calling performDelete...');
                    await this.performDelete(record);
                } else {
                    console.log('âŒ Delete cancelled by user');
                }
            }
            
            async performDelete(record) {
                console.log('ğŸ—‘ï¸ Performing delete for record:', record);
                
                try {
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    const accessToken = tokenResponse.accessToken;
                    
                    // Delete record
                    const deleteUrl = this.dataverseConfig.baseUrl + `socio_deltakelses(${record.socio_deltakelseid})`;
                    console.log('ğŸ”— Delete URL:', deleteUrl);
                    console.log('ğŸ†” Record ID:', record.socio_deltakelseid);
                    
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        console.log('âœ… Attendance record deleted successfully');
                        alert('Registrering slettet!');
                        // Refresh the list
                        this.showAttendanceList();
                    } else {
                        const error = await response.text();
                        console.error('âŒ Failed to delete attendance record:', response.status, error);
                        console.error('âŒ Response headers:', response.headers);
                        console.error('âŒ Response status text:', response.statusText);
                        alert(`Feil ved sletting: ${response.status} - ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ Attendance deletion error:', error);
                    alert('En feil oppstod ved sletting. PrÃ¸v igjen.');
                }
            }
            
            getTypeName(typeValue) {
                const typeNames = {
                    624610000: 'Tilstede',
                    624610001: 'FravÃ¦r', 
                    624610002: 'Deltakelse',
                    624610003: 'Permisjon',
                    624610004: 'Syk'
                };
                return typeNames[typeValue] || 'Ukjent';
            }
            
            async getEntityMetadata(entityName) {
                console.log(`ğŸ” Fetching metadata for entity: ${entityName}`);
                
                if (!this.dataverseConfig) {
                    console.log('âŒ Dataverse not configured');
                    return null;
                }
                
                try {
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    const accessToken = tokenResponse.accessToken;
                    
                    // Try to fetch entity metadata with correct headers
                    const metadataUrl = this.dataverseConfig.baseUrl + `$metadata#EntityDefinitions('${entityName}')`;
                    console.log('ğŸ”— Metadata URL:', metadataUrl);
                    
                    const response = await fetch(metadataUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/xml, application/json',
                            'OData-MaxVersion': '4.0',
                            'OData-Version': '4.0'
                        }
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        console.log('ğŸ“„ Response content type:', contentType);
                        
                        if (contentType && contentType.includes('application/json')) {
                            const metadata = await response.json();
                            console.log('âœ… Entity metadata (JSON):', metadata);
                            
                            // Log available properties
                            if (metadata && metadata.Properties) {
                                console.log('ğŸ“‹ Available properties:');
                                metadata.Properties.forEach(prop => {
                                    console.log(`  - ${prop.Name} (${prop.Type})`);
                                });
                            }
                            
                            return metadata;
                        } else {
                            // Handle XML response
                            const metadataXml = await response.text();
                            console.log('âœ… Entity metadata (XML):', metadataXml);
                            
                            // Try to extract field names from XML
                            const fieldMatches = metadataXml.match(/<Property Name="([^"]+)"/g);
                            if (fieldMatches) {
                                console.log('ğŸ“‹ Available fields from XML:');
                                fieldMatches.forEach(match => {
                                    const fieldName = match.match(/Name="([^"]+)"/)[1];
                                    console.log(`  - ${fieldName}`);
                                });
                            }
                            
                            return metadataXml;
                        }
                    } else {
                        console.error('âŒ Failed to fetch metadata:', response.status);
                        return null;
                    }
                    
                } catch (error) {
                    console.error('âŒ Error fetching metadata:', error);
                    return null;
                }
            }
            
            async fetchSampleRecord() {
                console.log('ğŸ” Fetching sample record to see field structure...');
                
                if (!this.dataverseConfig) {
                    console.log('âŒ Dataverse not configured');
                    return null;
                }
                
                try {
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    const accessToken = tokenResponse.accessToken;
                    
                    // Fetch first record to see field structure
                    const response = await fetch(this.dataverseConfig.baseUrl + 'socio_deltakelses?$top=1', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json',
                            'OData-MaxVersion': '4.0',
                            'OData-Version': '4.0'
                        }
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        if (responseText.trim()) {
                            try {
                                const data = JSON.parse(responseText);
                                console.log('âœ… Sample record structure:', data);
                                
                                if (data.value && data.value.length > 0) {
                                    const sampleRecord = data.value[0];
                                    console.log('ğŸ“‹ Available fields in sample record:');
                                    Object.keys(sampleRecord).forEach(field => {
                                        console.log(`  - ${field}: ${typeof sampleRecord[field]} = ${sampleRecord[field]}`);
                                    });
                                }
                                
                                return data;
                            } catch (parseError) {
                                console.error('âŒ Failed to parse sample record:', parseError);
                                return null;
                            }
                        } else {
                            console.log('âœ… No sample records found (empty response)');
                            return null;
                        }
                    } else {
                        console.error('âŒ Failed to fetch sample record:', response.status);
                        return null;
                    }
                    
                } catch (error) {
                    console.error('âŒ Error fetching sample record:', error);
                    return null;
                }
            }
            
            async handleEditAttendanceSubmit() {
                console.log('ğŸ’¾ Handling edit attendance form submission...');
                
                if (!this.currentEditRecordId) {
                    alert('Ingen registrering valgt for redigering.');
                    return;
                }
                
                const form = document.getElementById('edit-attendance-form');
                const formData = new FormData(form);
                
                const attendanceData = {
                    socio_dato: formData.get('socio_dato'),
                    socio_fra_klokke: formData.get('socio_fra_klokke'),
                    socio_til_klokke: formData.get('socio_til_klokke'),
                    socio_type: parseInt(formData.get('socio_type')),
                    socio_beskrivelse: formData.get('socio_beskrivelse') || ''
                };
                
                // Validate required fields
                if (!attendanceData.socio_dato || !attendanceData.socio_fra_klokke || !attendanceData.socio_til_klokke || !attendanceData.socio_type) {
                    alert('Vennligst fyll ut alle pÃ¥krevde felt.');
                    return;
                }
                
                // Calculate duration in hours as a number
                let durationHours = 0;
                if (attendanceData.socio_fra_klokke && attendanceData.socio_til_klokke) {
                    const from = new Date(`2000-01-01T${attendanceData.socio_fra_klokke}`);
                    const to = new Date(`2000-01-01T${attendanceData.socio_til_klokke}`);
                    const diffMs = to - from;
                    durationHours = diffMs / (1000 * 60 * 60);
                }
                
                // Prepare Dataverse payload for update with correct field names
                const payload = {
                    'socio_deltagelse_fra': attendanceData.socio_dato + 'T' + attendanceData.socio_fra_klokke + ':00',
                    'socio_deltagelse_til': attendanceData.socio_dato + 'T' + attendanceData.socio_til_klokke + ':00',
                    'socio_beskrivelse': attendanceData.socio_beskrivelse || null,
                    'socio_typedeltagelse': parseInt(attendanceData.socio_type),
                    'socio_varighet': durationHours
                };
                
                console.log('ğŸ” Sending minimal update payload:', payload);
                
                // Remove null/empty values
                Object.keys(payload).forEach(key => {
                    if (payload[key] === null || payload[key] === undefined || payload[key] === '') {
                        delete payload[key];
                    }
                });
                
                console.log('ğŸ“¤ Updating record in Dataverse:', payload);
                
                try {
                    // Get access token
                    const tokenRequest = {
                        scopes: ['https://flyktningportalenutvikling.crm4.dynamics.com/.default'],
                        account: this.currentUser?.account
                    };
                    
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    const accessToken = tokenResponse.accessToken;
                    
                    // Update record
                    const response = await fetch(this.dataverseConfig.baseUrl + `socio_deltakelses(${this.currentEditRecordId})`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        console.log('âœ… Attendance updated successfully');
                        alert('Registrering oppdatert!');
                        this.showScreen('attendance-list-screen');
                        // Refresh the list
                        this.showAttendanceList();
                    } else {
                        const error = await response.text();
                        console.error('âŒ Failed to update attendance:', response.status, error);
                        alert(`Feil ved oppdatering: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ Attendance update error:', error);
                    alert('En feil oppstod ved oppdatering. PrÃ¸v igjen.');
                }
            }
        }
        
        // Initialize app when page loads
        window.addEventListener('load', () => {
            console.log('ğŸŒ Window loaded, creating CleanApp...');
            window.cleanApp = new CleanApp();
            window.cleanApp.initialize();
        });
        
        console.log('=== CLEAN APP SCRIPT LOADED ===');
    </script>
</body>
</html>
