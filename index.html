<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frav√¶r Registrering - Clean</title>
    <meta name="description" content="App for flyktninger til √• registrere deltakelse og frav√¶r">
    <meta name="theme-color" content="#0078d4">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- MSAL Library - Force use of real MSAL for Entra ID authentication -->
    <script src="https://alcdn.msauth.net/browser/2.38.4/js/msal-browser.min.js" 
            integrity="sha384-..." 
            crossorigin="anonymous"
            onerror="console.error('Failed to load real MSAL, trying alternative...'); 
                     var script = document.createElement('script');
                     script.src = 'https://unpkg.com/@azure/msal-browser@latest/dist/msal-browser.min.js';
                     script.onload = function() { console.log('‚úÖ Real MSAL loaded from unpkg'); };
                     script.onerror = function() { 
                         console.error('All real MSAL sources failed, loading local implementation');
                         var localScript = document.createElement('script');
                         localScript.src = 'lib/msal-browser.min.js';
                         document.head.appendChild(localScript);
                     };
                     document.head.appendChild(script);"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Laster app...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen hidden">
        <div class="login-container">
            <div class="login-header">
                <h1>Frav√¶r Registrering</h1>
                <p>For flyktninger</p>
            </div>
            <div class="login-content">
                <button id="login-btn" class="btn btn-primary">
                    <span class="icon">üîê</span>
                    Logg inn
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-screen" class="screen hidden">
        <div class="screen-header">
            <h1>Frav√¶r Registrering</h1>
            <div class="user-info">
                <span id="user-name">Bruker</span>
                <button id="logout-btn" class="btn-logout">Logg ut</button>
            </div>
        </div>
        <div class="screen-content">
            <div class="menu-cards">
                <div class="menu-card">
                    <h3>Registrer deltakelse</h3>
                    <p>Meld frav√¶r eller deltakelse</p>
                    <button class="btn btn-primary">Start</button>
                </div>
                <div class="menu-card">
                    <h3>Se oversikt</h3>
                    <p>Se din frav√¶rsoversikt</p>
                    <button class="btn btn-secondary">√Öpne</button>
                </div>
                <div class="menu-card">
                    <h3>Test Dataverse</h3>
                    <p>Test tilkobling til Dataverse</p>
                    <button id="test-dataverse-btn" class="btn btn-info">Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple App Script -->
    <script>
        console.log('=== CLEAN APP STARTING ===');
        console.log('Timestamp:', new Date().toISOString());
        
        class CleanApp {
            constructor() {
                console.log('üöÄ CleanApp constructor called');
                this.currentScreen = 'loading-screen';
                this.initialized = false;
                this.msalInstance = null;
                this.currentUser = null;
            }
            
            async initialize() {
                if (this.initialized) {
                    console.log('App already initialized, skipping...');
                    return;
                }
                
                console.log('üîß Initializing CleanApp...');
                this.initialized = true;
                
                // Initialize MSAL
                await this.initializeMSAL();
                
                // Initialize Service Worker
                await this.initializeServiceWorker();
                
                // Initialize Dataverse
                await this.initializeDataverse();
                
                // Show login screen after 2 seconds
                setTimeout(() => {
                    console.log('‚è∞ Timeout reached, showing login screen...');
                    this.showScreen('login-screen');
                    
                    // Fallback: Force show login screen if still on loading
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                            console.log('üö® Fallback: Force showing login screen');
                            loadingScreen.classList.add('hidden');
                            loadingScreen.style.display = 'none';
                            const loginScreen = document.getElementById('login-screen');
                            if (loginScreen) {
                                loginScreen.classList.remove('hidden');
                                loginScreen.style.display = 'flex';
                                console.log('üö® Fallback: Login screen forced to show');
                            }
                        }
                    }, 1000);
                }, 2000);
                
                // Set up event listeners
                this.setupEventListeners();
                
                console.log('‚úÖ CleanApp initialized successfully');
            }
            
            async initializeMSAL() {
                console.log('üîê Initializing MSAL...');
                
                if (typeof msal === 'undefined') {
                    console.log('MSAL not available, using mock authentication');
                    return;
                }
                
                // Check if we have real MSAL or local implementation
                if (msal.PublicClientApplication && msal.PublicClientApplication.prototype.loginPopup) {
                    console.log('‚úÖ Real Microsoft MSAL detected');
                } else {
                    console.log('‚ö†Ô∏è Local MSAL implementation detected, limited functionality');
                }
                
                try {
                    // Real Entra ID configuration from CONFIG
                    const msalConfig = {
                        auth: {
                            clientId: 'c25b351f-417b-46cf-b736-2970d45273fc',
                            authority: 'https://login.microsoftonline.com/fb7e0b12-d8fc-4f14-bd1a-ad9c8667a7e6',
                            redirectUri: window.location.origin
                        },
                        cache: {
                            cacheLocation: 'localStorage',
                            storeAuthStateInCookie: false
                        }
                    };
                    
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    
                    // Handle redirect promise
                    await this.msalInstance.handleRedirectPromise();
                    
                    console.log('‚úÖ MSAL initialized successfully with Entra ID');
                } catch (error) {
                    console.error('‚ùå MSAL initialization failed:', error);
                    console.log('Falling back to mock authentication');
                }
            }
            
            async initializeServiceWorker() {
                console.log('üîß Initializing Service Worker...');
                
                if (!('serviceWorker' in navigator)) {
                    console.log('Service Worker not supported');
                    return;
                }
                
                if (window.serviceWorkerRegistered) {
                    console.log('Service Worker already registered');
                    return;
                }
                
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registered successfully:', registration);
                    window.serviceWorkerRegistered = true;
                } catch (error) {
                    console.error('‚ùå Service Worker registration failed:', error);
                }
            }
            
            async initializeDataverse() {
                console.log('üóÑÔ∏è Initializing Dataverse...');
                
                try {
                    // Real Dataverse configuration from CONFIG
                    this.dataverseConfig = {
                        baseUrl: 'https://smittevaksine2022utvikling.crm4.dynamics.com/api/data/v9.2/',
                        apiVersion: '9.2',
                        entities: {
                            user: 'new_bruker',
                            participation: 'new_deltakelse',
                            absence: 'new_frav√¶r'
                        },
                        mockMode: false // Set to true for offline development
                    };
                    
                    console.log('‚úÖ Dataverse initialized successfully');
                } catch (error) {
                    console.error('‚ùå Dataverse initialization failed:', error);
                }
            }
            
            showScreen(screenId) {
                console.log('üì± Showing screen:', screenId);
                
                // Hide all screens with multiple methods
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                });
                
                // Show target screen with multiple methods
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.style.display = 'flex';
                    this.currentScreen = screenId;
                    console.log('‚úÖ Screen shown:', screenId);
                    console.log('Screen element:', targetScreen);
                    console.log('Screen classes:', targetScreen.className);
                    console.log('Screen style:', targetScreen.style.display);
                } else {
                    console.error('‚ùå Screen not found:', screenId);
                }
            }
            
            setupEventListeners() {
                console.log('üîó Setting up event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        console.log('üîê Login button clicked');
                        this.handleLogin();
                    });
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log('üö™ Logout button clicked');
                        this.handleLogout();
                    });
                }
                
                // Test Dataverse button
                const testDataverseBtn = document.getElementById('test-dataverse-btn');
                if (testDataverseBtn) {
                    testDataverseBtn.addEventListener('click', async () => {
                        console.log('üîó Test Dataverse button clicked');
                        const result = await this.testDataverseConnection();
                        console.log('Dataverse test result:', result);
                        alert(`Dataverse test: ${result.success ? 'Success' : 'Failed'} - ${result.message}`);
                    });
                }
                
                console.log('‚úÖ Event listeners set up');
            }
            
            async handleLogin() {
                console.log('üîê Handling login...');
                
                if (this.msalInstance) {
                    try {
                        console.log('Using MSAL for Entra ID authentication...');
                        
                        // Check if user is already logged in
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            console.log('User already logged in:', accounts[0]);
                            this.currentUser = {
                                name: accounts[0].name,
                                email: accounts[0].username,
                                account: accounts[0]
                            };
                            this.showScreen('main-screen');
                            return;
                        }
                        
                        // Login with popup
                        const loginRequest = {
                            scopes: ['User.Read'],
                            prompt: 'select_account'
                        };
                        
                        const response = await this.msalInstance.loginPopup(loginRequest);
                        console.log('‚úÖ Entra ID login successful:', response);
                        
                        this.currentUser = {
                            name: response.account.name,
                            email: response.account.username,
                            account: response.account
                        };
                        
                    } catch (error) {
                        console.error('‚ùå Entra ID login failed:', error);
                        console.log('Falling back to mock authentication');
                        this.currentUser = { name: 'Test User', email: 'test@example.com' };
                    }
                } else {
                    console.log('Using mock authentication...');
                    this.currentUser = { name: 'Test User', email: 'test@example.com' };
                }
                
                this.showScreen('main-screen');
                this.updateUserInfo();
            }
            
            async handleLogout() {
                console.log('üö™ Handling logout...');
                
                if (this.msalInstance && this.currentUser && this.currentUser.account) {
                    try {
                        console.log('Logging out from Entra ID...');
                        await this.msalInstance.logoutPopup();
                        console.log('‚úÖ Entra ID logout successful');
                    } catch (error) {
                        console.error('‚ùå Entra ID logout failed:', error);
                    }
                }
                
                this.currentUser = null;
                this.showScreen('login-screen');
            }
            
            updateUserInfo() {
                console.log('üë§ Updating user info...');
                
                const userNameElement = document.getElementById('user-name');
                if (userNameElement && this.currentUser) {
                    userNameElement.textContent = this.currentUser.name || this.currentUser.email || 'Bruker';
                    console.log('‚úÖ User info updated:', this.currentUser.name);
                }
            }
            
            async testDataverseConnection() {
                console.log('üîó Testing Dataverse connection...');
                
                if (this.dataverseConfig && this.dataverseConfig.mockMode) {
                    console.log('‚úÖ Dataverse connection test successful (mock mode)');
                    return { success: true, message: 'Mock connection successful' };
                } else if (this.dataverseConfig) {
                    try {
                        // Test real Dataverse connection
                        const response = await fetch(this.dataverseConfig.baseUrl + 'WhoAmI()', {
                            headers: {
                                'Authorization': 'Bearer ' + (this.currentUser?.account?.accessToken || 'mock-token'),
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Dataverse connection test successful');
                            return { success: true, message: 'Real Dataverse connection successful' };
                        } else {
                            console.log('‚ùå Dataverse connection test failed:', response.status);
                            return { success: false, message: `Connection failed: ${response.status}` };
                        }
                    } catch (error) {
                        console.error('‚ùå Dataverse connection test error:', error);
                        return { success: false, message: 'Connection error: ' + error.message };
                    }
                } else {
                    console.log('‚ùå Dataverse not configured');
                    return { success: false, message: 'Dataverse not configured' };
                }
            }
        }
        
        // Initialize app when page loads
        window.addEventListener('load', () => {
            console.log('üåê Window loaded, creating CleanApp...');
            window.cleanApp = new CleanApp();
            window.cleanApp.initialize();
        });
        
        console.log('=== CLEAN APP SCRIPT LOADED ===');
    </script>
</body>
</html>
